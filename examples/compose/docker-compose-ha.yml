# ================================
# ZAIRAKAI DOCKER ECOSYSTEM
# High Availability Configuration
# ================================
# MySQL Master-Slave Replication + Redis Sentinel
#
# Usage:
#   docker-compose -f docker-compose-ha.yml up -d
#   docker-compose -f docker-compose-ha.yml exec mysql-master /scripts/setup-master.sh
#   docker-compose -f docker-compose-ha.yml exec mysql-slave /scripts/setup-slave.sh

services:
  # ================================
  # PHP Application
  # ================================
  php:
    image: registry.gitlab.com/zairakai/docker-ecosystem/php:8.3-dev
    container_name: php-app
    environment:
      APP_ENV: development
      APP_DEBUG: "true"

      # Database (write to master, read from slave)
      DB_CONNECTION: mysql
      DB_HOST: mysql-master
      DB_PORT: 3306
      DB_DATABASE: app
      DB_USERNAME: app_user
      DB_PASSWORD: secret

      # Read replica configuration
      DB_READ_HOST: mysql-slave

      # Redis Sentinel
      REDIS_SENTINEL_SERVICE: mymaster
      REDIS_SENTINELS: "redis-sentinel-1:26379,redis-sentinel-2:26379,redis-sentinel-3:26379"

    depends_on:
      - mysql-master
      - mysql-slave
      - redis-master
    networks:
      - app-network

  # ================================
  # MySQL Master-Slave Replication
  # ================================

  # MySQL Master (Read/Write)
  mysql-master:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:mysql-8.0
    container_name: mysql-master
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootsecret
      MYSQL_DATABASE: app
      MYSQL_USER: app_user
      MYSQL_PASSWORD: secret
      REPLICATION_PASSWORD: replication_secret
      MONITOR_PASSWORD: monitor_secret
    volumes:
      - mysql-master-data:/var/lib/mysql
      - ../images/database/mysql/8.0/config/master.cnf:/etc/mysql/conf.d/replication.cnf:ro
      - ../images/database/mysql/8.0/scripts/setup-master.sh:/scripts/setup-master.sh:ro
    ports:
      - "3306:3306"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootsecret"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL Slave 1 (Read-Only)
  mysql-slave:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:mysql-8.0
    container_name: mysql-slave-1
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootsecret
      MYSQL_DATABASE: app
      MYSQL_USER: app_user
      MYSQL_PASSWORD: secret

      # Replication configuration
      MYSQL_MASTER_HOST: mysql-master
      MYSQL_MASTER_PORT: 3306
      REPLICATION_USER: replication
      REPLICATION_PASSWORD: replication_secret
    volumes:
      - mysql-slave-1-data:/var/lib/mysql
      - ../images/database/mysql/8.0/config/slave.cnf:/etc/mysql/conf.d/replication.cnf:ro
      - ../images/database/mysql/8.0/scripts/setup-slave.sh:/scripts/setup-slave.sh:ro
    ports:
      - "3307:3306"
    depends_on:
      - mysql-master
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootsecret"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL Slave 2 (Read-Only) - Optional
  mysql-slave-2:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:mysql-8.0
    container_name: mysql-slave-2
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootsecret
      MYSQL_DATABASE: app
      MYSQL_USER: app_user
      MYSQL_PASSWORD: secret

      # Replication configuration
      MYSQL_MASTER_HOST: mysql-master
      MYSQL_MASTER_PORT: 3306
      REPLICATION_USER: replication
      REPLICATION_PASSWORD: replication_secret
    volumes:
      - mysql-slave-2-data:/var/lib/mysql
      - ../images/database/mysql/8.0/config/slave.cnf:/etc/mysql/conf.d/replication.cnf:ro
      - ../images/database/mysql/8.0/scripts/setup-slave.sh:/scripts/setup-slave.sh:ro
    ports:
      - "3308:3306"
    depends_on:
      - mysql-master
    networks:
      - app-network
    profiles:
      - full-ha  # Only start with --profile full-ha

  # ================================
  # Redis Sentinel Configuration
  # ================================

  # Redis Master
  redis-master:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:redis-7
    container_name: redis-master
    command: redis-server --appendonly yes --requirepass redissecret
    ports:
      - "6379:6379"
    volumes:
      - redis-master-data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Redis Slave 1
  redis-slave-1:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:redis-7
    container_name: redis-slave-1
    command: redis-server --slaveof redis-master 6379 --appendonly yes --requirepass redissecret --masterauth redissecret
    ports:
      - "6380:6379"
    volumes:
      - redis-slave-1-data:/data
    depends_on:
      - redis-master
    networks:
      - app-network

  # Redis Slave 2
  redis-slave-2:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:redis-7
    container_name: redis-slave-2
    command: redis-server --slaveof redis-master 6379 --appendonly yes --requirepass redissecret --masterauth redissecret
    ports:
      - "6381:6379"
    volumes:
      - redis-slave-2-data:/data
    depends_on:
      - redis-master
    networks:
      - app-network

  # Redis Sentinel 1
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: redis-sentinel-1
    command: redis-sentinel /etc/redis/sentinel.conf
    ports:
      - "26379:26379"
    volumes:
      - ./redis-sentinel.conf:/etc/redis/sentinel.conf:ro
    depends_on:
      - redis-master
    networks:
      - app-network

  # Redis Sentinel 2
  redis-sentinel-2:
    image: redis:7-alpine
    container_name: redis-sentinel-2
    command: redis-sentinel /etc/redis/sentinel.conf
    ports:
      - "26380:26379"
    volumes:
      - ./redis-sentinel.conf:/etc/redis/sentinel.conf:ro
    depends_on:
      - redis-master
    networks:
      - app-network

  # Redis Sentinel 3
  redis-sentinel-3:
    image: redis:7-alpine
    container_name: redis-sentinel-3
    command: redis-sentinel /etc/redis/sentinel.conf
    ports:
      - "26381:26379"
    volumes:
      - ./redis-sentinel.conf:/etc/redis/sentinel.conf:ro
    depends_on:
      - redis-master
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mysql-master-data:
  mysql-slave-1-data:
  mysql-slave-2-data:
  redis-master-data:
  redis-slave-1-data:
  redis-slave-2-data:
