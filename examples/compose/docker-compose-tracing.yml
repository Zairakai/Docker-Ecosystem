# ================================
# ZAIRAKAI DOCKER ECOSYSTEM
# OpenTelemetry Distributed Tracing Stack
# ================================
# Complete observability stack with Jaeger and Zipkin

version: '3.8'

services:
  # ================================
  # APPLICATION SERVICES
  # ================================

  # PHP Laravel Application
  php:
    image: registry.gitlab.com/zairakai/docker-ecosystem/php:8.3-dev
    container_name: laravel-app
    ports:
      - "9000:9000"   # PHP-FPM
      - "9253:9253"   # Prometheus metrics
    volumes:
      - ../app:/var/www/html
    environment:
      # OpenTelemetry Configuration
      OTEL_ENABLED: "true"
      OTEL_SERVICE_NAME: laravel-app
      OTEL_SERVICE_VERSION: "1.0.0"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_TRACES_SAMPLER: always_on
      # Laravel Configuration
      APP_ENV: development
      APP_DEBUG: "true"
      LOG_CHANNEL: json
      LOG_LEVEL: debug
      # Database
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: app
      DB_USERNAME: root
      DB_PASSWORD: secret
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - mysql
      - redis
      - otel-collector
    networks:
      - app-network

  # Node.js Application
  node:
    image: registry.gitlab.com/zairakai/docker-ecosystem/node:20-dev
    container_name: node-app
    ports:
      - "3000:3000"   # Application
      - "9090:9090"   # Prometheus metrics
      - "9229:9229"   # Node inspector
    volumes:
      - ../node-app:/app
    environment:
      # OpenTelemetry Configuration
      OTEL_SERVICE_NAME: node-app
      OTEL_SERVICE_VERSION: "1.0.0"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      # Node.js Configuration
      NODE_ENV: development
      LOG_LEVEL: debug
      APP_NAME: vue-frontend
      # Services
      API_URL: http://php:9000
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - php
      - redis
      - otel-collector
    networks:
      - app-network

  # Nginx Web Server
  nginx:
    image: registry.gitlab.com/zairakai/docker-ecosystem/web:nginx-1.26
    container_name: nginx-server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../app:/var/www/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php
      - node
    networks:
      - app-network

  # ================================
  # DATABASES & CACHE
  # ================================

  # MySQL Database
  mysql:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:mysql-8.0
    container_name: mysql-db
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: app
      MYSQL_USER: app_user
      MYSQL_PASSWORD: app_password
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - app-network

  # Redis Cache
  redis:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:redis-7
    container_name: redis-cache
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network

  # ================================
  # OBSERVABILITY STACK
  # ================================

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.91.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ./otel-collector-config.yml:/etc/otel-collector-config.yml
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "13133:13133" # Health check extension
      - "8888:8888"   # Prometheus metrics (collector itself)
      - "8889:8889"   # Prometheus exporter
    depends_on:
      - jaeger
      - zipkin
    networks:
      - app-network

  # Jaeger All-in-One
  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: jaeger-tracing
    ports:
      - "5775:5775/udp"   # Zipkin Thrift compact (deprecated)
      - "6831:6831/udp"   # Jaeger Thrift compact
      - "6832:6832/udp"   # Jaeger Thrift binary
      - "5778:5778"       # Serve configs
      - "16686:16686"     # Jaeger UI
      - "14250:14250"     # Jaeger gRPC
      - "14268:14268"     # Jaeger HTTP Thrift
      - "14269:14269"     # Jaeger admin port
      - "9411:9411"       # Zipkin compatible endpoint
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
      COLLECTOR_OTLP_ENABLED: "true"
      LOG_LEVEL: debug
    volumes:
      - jaeger-data:/badger
    networks:
      - app-network

  # Zipkin
  zipkin:
    image: openzipkin/zipkin:2.24
    container_name: zipkin-tracing
    ports:
      - "9412:9411"   # Zipkin UI and API (mapped to 9412 to avoid conflict with Jaeger)
    environment:
      STORAGE_TYPE: mem
      JAVA_OPTS: "-Xms512m -Xmx512m"
    networks:
      - app-network

  # Prometheus
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus-monitoring
    ports:
      - "9091:9090"   # Prometheus UI
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    depends_on:
      - php
      - node
      - otel-collector
    networks:
      - app-network

  # Grafana
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana-dashboard
    ports:
      - "3001:3000"   # Grafana UI (mapped to 3001 to avoid conflict with node)
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
    depends_on:
      - prometheus
      - jaeger
    networks:
      - app-network

# ================================
# NETWORKS
# ================================
networks:
  app-network:
    driver: bridge

# ================================
# VOLUMES
# ================================
volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  jaeger-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
