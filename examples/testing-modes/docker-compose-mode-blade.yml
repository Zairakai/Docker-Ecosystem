version: '3.8'

# Testing Mode: Blade-only (Pure SSR)
# Traditional Laravel application with Blade templates only
# No JavaScript framework, no Node.js build step required
# HTML generated entirely server-side by PHP

services:
  # Nginx - Blade-only configuration
  nginx:
    image: registry.gitlab.com/zairakai/docker-ecosystem/web:nginx-1.26
    ports:
      - "80:80"
    volumes:
      - ./nginx-mode-blade-only.conf:/etc/nginx/conf.d/default.conf
      - laravel-app:/var/www/html
    depends_on:
      - php
    networks:
      - app-network

  # PHP - Laravel with Blade rendering (no Node.js needed)
  php:
    image: registry.gitlab.com/zairakai/docker-ecosystem/php:8.3-test
    volumes:
      - laravel-app:/var/www/html
    environment:
      - APP_ENV=testing
      - APP_MODE=blade-ssr
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    networks:
      - app-network

  mysql:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:mysql-8.0
    environment:
      - MYSQL_ROOT_PASSWORD=secret
      - MYSQL_DATABASE=testing
      - MYSQL_USER=laravel
      - MYSQL_PASSWORD=secret
    networks:
      - app-network

  redis:
    image: registry.gitlab.com/zairakai/docker-ecosystem/database:redis-7
    networks:
      - app-network

  # E2E Testing - Gherkin tests for Blade HTML
  e2e-testing:
    image: registry.gitlab.com/zairakai/docker-ecosystem/services:e2e-testing
    volumes:
      - ./tests/e2e/features-blade:/app/features
      - ./tests/e2e/step-definitions:/app/step-definitions
      - ./tests/e2e/reports:/app/reports
    environment:
      - BASE_URL=http://nginx
      - TEST_MODE=blade-ssr
      - HEADLESS=true
    depends_on:
      - nginx
    networks:
      - app-network
    command: /usr/local/bin/run-tests.sh

volumes:
  laravel-app:  # Laravel application (no compiled assets needed)

networks:
  app-network:
    driver: bridge
