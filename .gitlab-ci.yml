# ================================
# ZAIRAKAI DOCKER ECOSYSTEM CI/CD
# ================================

stages:
  - validate
  - security
  - build-prod
  - build-services-core
  - build-services-extra
  - test
  - promote
  - cleanup

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  IMAGE_SUFFIX: "-$CI_COMMIT_SHORT_SHA"
  SECURE_ANALYZERS_PREFIX: "$CI_TEMPLATE_REGISTRY_HOST/security-products"
  SAST_EXCLUDED_PATHS: "tests/,node_modules/,vendor/,coverage/,dist/,*.min.js,*.min.css"
  DS_EXCLUDED_PATHS: "examples/,docs/,tests/"
  SAST_IAC_EXCLUDED_PATHS: "examples/,docs/,tests/"
  SECRET_DETECTION_EXCLUDED_PATHS: "examples/,docs/,tests/"

# Note: docker_auth merged into build_base template for simplicity

# ================================
# SECURITY SCANNING
# ================================
include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/SAST-IaC.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

dependency_scanning:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

iac-sast:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

secret_detection:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

# ================================
# VALIDATION STAGE
# ================================
validate:config:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache bash findutils
  script:
    - bash scripts/pipeline/validate-config.sh

validate:shellcheck:
  stage: validate
  image: koalaman/shellcheck-alpine:stable
  before_script:
    - apk add --no-cache bash
  script:
    - bash scripts/pipeline/validate-shellcheck.sh
  allow_failure: false

# ================================
# BUILD TEMPLATES
# ================================
.build_base: &build_base
  image: docker:27-cli
  before_script:
    - apk add --no-cache bash
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    # Ensure all scripts are executable (defensive)
    - chmod -R +x scripts/
  after_script:
    - docker logout $CI_REGISTRY
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 1

# ================================
# BUILD CORE IMAGES (Multi-stage: prod â†’ dev â†’ test)
# ================================
build:php:
  <<: *build_base
  stage: build-prod
  needs:
    - validate:config
    - validate:shellcheck
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/php/8.3 php 8.3-prod
    - bash scripts/pipeline/build-image.sh images/php/8.3 php 8.3-dev
    - bash scripts/pipeline/build-image.sh images/php/8.3 php 8.3-test
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:node:
  <<: *build_base
  stage: build-prod
  needs:
    - validate:config
    - validate:shellcheck
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/node/20 node 20-prod
    - bash scripts/pipeline/build-image.sh images/node/20 node 20-dev
    - bash scripts/pipeline/build-image.sh images/node/20 node 20-test
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# BUILD SERVICES CORE (Group 1: Critical services after PHP/Node)
# ================================
build:mysql:
  <<: *build_base
  stage: build-services-core
  needs:
    - build:php
    - build:node
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/database/mysql/8.0 database mysql-8.0
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:redis:
  <<: *build_base
  stage: build-services-core
  needs:
    - build:php
    - build:node
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/database/redis/7 database redis-7
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:nginx:
  <<: *build_base
  stage: build-services-core
  needs:
    - build:php
    - build:node
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/web/nginx/1.26 web nginx-1.26
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# BUILD SERVICES EXTRA (Group 2: Secondary services)
# ================================
build:mailhog:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/services/mailhog services mailhog
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:minio:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/services/minio services minio
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:e2e-testing:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/services/e2e-testing services e2e-testing
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:performance-testing:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  variables:
    PUSH_TO_REGISTRY: "false"
  script:
    - bash scripts/pipeline/build-image.sh images/services/performance-testing services performance-testing
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# TEST STAGE
# ================================
test:image-sizes:
  stage: test
  image: docker:27-cli
  needs:
    - build:php
    - build:node
    - build:mysql
    - build:redis
    - build:nginx
    - build:mailhog
    - build:minio
    - build:e2e-testing
    - build:performance-testing
  before_script:
    - apk add --no-cache bash
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - bash scripts/pipeline/test-image-sizes.sh
  artifacts:
    paths:
      - image-sizes.txt
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

test:multi-stage-integrity:
  stage: test
  image: docker:27-cli
  needs:
    - build:php
    - build:node
    - build:mysql
    - build:redis
    - build:nginx
    - build:mailhog
    - build:minio
    - build:e2e-testing
    - build:performance-testing
  before_script:
    - apk add --no-cache bash
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - bash scripts/pipeline/test-multi-stage.sh
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# PROMOTE STAGE
# ================================
promote:tags:
  stage: promote
  image: docker:27-cli
  needs:
    - build:php
    - build:node
    - build:mysql
    - build:redis
    - build:nginx
    - build:mailhog
    - build:minio
    - build:e2e-testing
    - build:performance-testing
    - test:image-sizes
    - test:multi-stage-integrity
  before_script:
    - apk add --no-cache bash
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸš€ Promoting images to stable tagsâ€¦"
    - chmod +x scripts/promote.sh
    - export PROMOTED_VERSION="$CI_COMMIT_TAG"
    - bash scripts/promote.sh
    - echo "âœ… Images promoted successfully"
  after_script:
    - docker logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

sync:dockerhub:
  stage: promote
  image: docker:27-cli
  needs:
    - promote:tags
  before_script:
    - apk add --no-cache bash
    # Login GitLab Registry
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - bash scripts/pipeline/sync-dockerhub.sh
  after_script:
    - docker logout $CI_REGISTRY || true
    - docker logout docker.io || true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  allow_failure: true

# ================================
# CLEANUP STAGE
# ================================
# NOTE: Cleanup disabled - staging images are built locally on runner (not pushed to registry)
# Runner's daily cleanup job handles local image cleanup instead
# cleanup:staging-tags:
#   stage: cleanup
#   image: docker:27-cli
#   needs:
#     - promote:tags
#   before_script:
#     - apk add --no-cache bash curl jq
#     - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
#   script:
#     - echo "ðŸ§¹ Cleaning up staging tagsâ€¦"
#     - chmod +x scripts/cleanup.sh
#     - bash scripts/cleanup.sh
#     - echo "âœ… Cleanup completed"
#   after_script:
#     - docker logout $CI_REGISTRY
#   rules:
#     - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
#   when: always
#   allow_failure: true
