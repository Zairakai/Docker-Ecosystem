# ================================
# ZAIRAKAI DOCKER ECOSYSTEM CI/CD
# ================================

stages:
  - validate
  - security
  - build-prod
  - build-dev
  - build-test
  - build-services-core
  - build-services-extra
  - test
  - promote
  - cleanup

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  IMAGE_SUFFIX: "-$CI_COMMIT_SHORT_SHA"
  SECURE_ANALYZERS_PREFIX: "$CI_TEMPLATE_REGISTRY_HOST/security-products"
  SAST_EXCLUDED_PATHS: "tests/,node_modules/,vendor/,coverage/,dist/,*.min.js,*.min.css"
  DS_EXCLUDED_PATHS: "examples/,docs/,tests/"
  SAST_IAC_EXCLUDED_PATHS: "examples/,docs/,tests/"
  SECRET_DETECTION_EXCLUDED_PATHS: "examples/,docs/,tests/"

# ================================
# GLOBAL DOCKER AUTH
# ================================
.docker_auth: &docker_auth
  before_script:
    - apk add --no-cache bash
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  after_script:
    - docker logout $CI_REGISTRY

# ================================
# SECURITY SCANNING
# ================================
include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/SAST-IaC.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

dependency_scanning:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

iac-sast:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

secret_detection:
  stage: security
  needs:
    - job: validate:config
      optional: true
    - job: validate:shellcheck
      optional: true

# ================================
# VALIDATION STAGE
# ================================
validate:config:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache bash findutils
  script:
    - echo "âœ“ Validating Docker Ecosystem configurationâ€¦"
    - |
      # Check Dockerfiles exist
      echo "â†’ Checking Dockerfilesâ€¦"
      find images/ -name "Dockerfile" | wc -l
      test -f images/php/8.3/Dockerfile
      test -f images/node/20/Dockerfile

      # Check scripts exist
      echo "â†’ Checking scriptsâ€¦"
      test -f scripts/build-all-images.sh
      test -f scripts/common.sh
      test -f scripts/docker-functions.sh
      test -f scripts/promote.sh
      test -f scripts/cleanup.sh

      # Check directories
      echo "â†’ Checking directoriesâ€¦"
      test -d examples/
      test -d images/database/mysql/8.0
      test -d images/database/redis/7
      test -d images/web/nginx/1.26
      test -d images/services/
    - echo "âœ… Configuration validation passed"

validate:shellcheck:
  stage: validate
  image: koalaman/shellcheck-alpine:stable
  script:
    - echo "âœ“ Running shellcheck on all shell scriptsâ€¦"
    - |
      find . -name "*.sh" -type f -print0 | \
      xargs -0 shellcheck --severity=warning --format=gcc
    - echo "âœ… Shellcheck validation passed"
  allow_failure: false

# ================================
# BUILD TEMPLATES
# ================================
.build_base: &build_base
  image: docker:27-cli
  <<: *docker_auth
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 1

# ================================
# BUILD PRODUCTION STAGE (Base images)
# ================================
build:php:prod:
  <<: *build_base
  stage: build-prod
  needs:
    - validate:config
    - validate:shellcheck
  script:
    - echo "ðŸ”¨ Building PHP 8.3-prod (BASE IMAGE)â€¦"
    - export BUILD_STAGE="prod"
    - export BUILD_TARGET="prod"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      # Build with cache optimization
            BUILDER_NAME="builder-php-prod-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --target prod \
        --cache-from "${CI_REGISTRY_IMAGE}/php:8.3-prod" \
        --cache-from "${CI_REGISTRY_IMAGE}/php:latest-prod" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/php:8.3${IMAGE_SUFFIX}-prod" \
        --push \
        images/php/8.3/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… PHP 8.3-prod built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:node:prod:
  <<: *build_base
  stage: build-prod
  needs:
    - validate:config
    - validate:shellcheck
  script:
    - echo "ðŸ”¨ Building Node.js 20-prod (BASE IMAGE)â€¦"
    - export BUILD_STAGE="prod"
    - export BUILD_TARGET="prod"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-node-prod-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --target prod \
        --cache-from "${CI_REGISTRY_IMAGE}/node:20-prod" \
        --cache-from "${CI_REGISTRY_IMAGE}/node:latest-prod" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/node:20${IMAGE_SUFFIX}-prod" \
        --push \
        images/node/20/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Node.js 20-prod built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# BUILD DEVELOPMENT STAGE
# ================================
build:php:dev:
  <<: *build_base
  stage: build-dev
  needs:
    - build:php:prod
  script:
    - echo "ðŸ”¨ Building PHP 8.3-dev (FROM prod stage)â€¦"
    - export BUILD_STAGE="dev"
    - export BUILD_TARGET="dev"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-php-dev-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --target dev \
        --cache-from "${CI_REGISTRY_IMAGE}/php:8.3${IMAGE_SUFFIX}-prod" \
        --cache-from "${CI_REGISTRY_IMAGE}/php:8.3-dev" \
        --cache-from "${CI_REGISTRY_IMAGE}/php:latest-dev" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/php:8.3${IMAGE_SUFFIX}-dev" \
        --push \
        images/php/8.3/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… PHP 8.3-dev built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:node:dev:
  <<: *build_base
  stage: build-dev
  needs:
    - build:node:prod
  script:
    - echo "ðŸ”¨ Building Node.js 20-dev (FROM prod stage)â€¦"
    - export BUILD_STAGE="dev"
    - export BUILD_TARGET="dev"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-node-dev-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --target dev \
        --cache-from "${CI_REGISTRY_IMAGE}/node:20${IMAGE_SUFFIX}-prod" \
        --cache-from "${CI_REGISTRY_IMAGE}/node:20-dev" \
        --cache-from "${CI_REGISTRY_IMAGE}/node:latest-dev" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/node:20${IMAGE_SUFFIX}-dev" \
        --push \
        images/node/20/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Node.js 20-dev built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# BUILD TESTING STAGE
# ================================
build:php:test:
  <<: *build_base
  stage: build-test
  needs:
    - build:php:dev
  script:
    - echo "ðŸ”¨ Building PHP 8.3-test (FROM dev stage)â€¦"
    - export BUILD_STAGE="test"
    - export BUILD_TARGET="test"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-php-test-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --target test \
        --cache-from "${CI_REGISTRY_IMAGE}/php:8.3${IMAGE_SUFFIX}-dev" \
        --cache-from "${CI_REGISTRY_IMAGE}/php:8.3-test" \
        --cache-from "${CI_REGISTRY_IMAGE}/php:latest-test" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/php:8.3${IMAGE_SUFFIX}-test" \
        --push \
        images/php/8.3/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… PHP 8.3-test built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:node:test:
  <<: *build_base
  stage: build-test
  needs:
    - build:node:dev
  script:
    - echo "ðŸ”¨ Building Node.js 20-test (FROM dev stage)â€¦"
    - export BUILD_STAGE="test"
    - export BUILD_TARGET="test"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-node-test-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --target test \
        --cache-from "${CI_REGISTRY_IMAGE}/node:20${IMAGE_SUFFIX}-dev" \
        --cache-from "${CI_REGISTRY_IMAGE}/node:20-test" \
        --cache-from "${CI_REGISTRY_IMAGE}/node:latest-test" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/node:20${IMAGE_SUFFIX}-test" \
        --push \
        images/node/20/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Node.js 20-test built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# BUILD SERVICES CORE (Group 1: Critical services after PHP/Node)
# ================================
build:mysql:
  <<: *build_base
  stage: build-services-core
  needs:
    - build:php:test
    - build:node:test
  script:
    - echo "ðŸ”¨ Building MySQL 8.0â€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-mysql-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --cache-from "${CI_REGISTRY_IMAGE}/database:mysql-8.0" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/database:mysql-8.0${IMAGE_SUFFIX}" \
        --push \
        images/database/mysql/8.0/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… MySQL 8.0 built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:redis:
  <<: *build_base
  stage: build-services-core
  needs:
    - build:php:test
    - build:node:test
  script:
    - echo "ðŸ”¨ Building Redis 7â€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-redis-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --cache-from "${CI_REGISTRY_IMAGE}/database:redis-7" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/database:redis-7${IMAGE_SUFFIX}" \
        --push \
        images/database/redis/7/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Redis 7 built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:nginx:
  <<: *build_base
  stage: build-services-core
  needs:
    - build:php:test
    - build:node:test
  script:
    - echo "ðŸ”¨ Building Nginx 1.26â€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-nginx-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --cache-from "${CI_REGISTRY_IMAGE}/web:nginx-1.26" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/web:nginx-1.26${IMAGE_SUFFIX}" \
        --push \
        images/web/nginx/1.26/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Nginx 1.26 built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# BUILD SERVICES EXTRA (Group 2: Secondary services)
# ================================
build:mailhog:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  script:
    - echo "ðŸ”¨ Building Mailhogâ€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-mailhog-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --cache-from "${CI_REGISTRY_IMAGE}/services:mailhog" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/services:mailhog${IMAGE_SUFFIX}" \
        --push \
        images/services/mailhog/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Mailhog built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:minio:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  script:
    - echo "ðŸ”¨ Building MinIOâ€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-minio-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --cache-from "${CI_REGISTRY_IMAGE}/services:minio" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/services:minio${IMAGE_SUFFIX}" \
        --push \
        images/services/minio/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… MinIO built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:e2e-testing:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  script:
    - echo "ðŸ”¨ Building E2E Testingâ€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-e2e-testing-${CI_PIPELINE_ID}"

      docker buildx create --use --name "${BUILDER_NAME}" || true

      docker buildx build \
        --cache-from "${CI_REGISTRY_IMAGE}/services:e2e-testing" \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --tag "${CI_REGISTRY_IMAGE}/services:e2e-testing${IMAGE_SUFFIX}" \
        --push \
        images/services/e2e-testing/

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… E2E Testing built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build:performance-testing:
  <<: *build_base
  stage: build-services-extra
  needs:
    - build:mysql
    - build:redis
    - build:nginx
  script:
    - echo "ðŸ”¨ Building Performance Testingâ€¦"
    - chmod +x scripts/docker-functions.sh scripts/common.sh
    - |
      bash <<'EOSCRIPT'
      set -euo pipefail
      source scripts/common.sh
      source scripts/docker-functions.sh

      export CACHE_ENABLED=true
      export PUSH_TO_REGISTRY=true
      export DOCKER_REGISTRY="${CI_REGISTRY_IMAGE}"
      export IMAGE_SUFFIX="${IMAGE_SUFFIX}"

      BUILDER_NAME="builder-performance-testing-${CI_PIPELINE_ID}"

      MAX_ATTEMPTS=3
      ATTEMPT=1

      docker buildx create --use --name "${BUILDER_NAME}" || true

      while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
        echo "Build attempt ${ATTEMPT}/${MAX_ATTEMPTS}â€¦"

        if docker buildx build \
          --cache-from "${CI_REGISTRY_IMAGE}/services:performance-testing" \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --tag "${CI_REGISTRY_IMAGE}/services:performance-testing${IMAGE_SUFFIX}" \
          --push \
          images/services/performance-testing/; then
          echo "âœ… Build successful"
          break
        else
          if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            echo "âš ï¸ Build failed, retrying in 10sâ€¦"
            sleep 10
          else
            echo "âŒ Build failed after ${MAX_ATTEMPTS} attempts"
            docker buildx rm "${BUILDER_NAME}" || true
            exit 1
          fi
        fi

        ATTEMPT=$((ATTEMPT + 1))
      done

      docker buildx rm "${BUILDER_NAME}" || true
      EOSCRIPT
    - echo "âœ… Performance Testing built successfully"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# TEST STAGE
# ================================
test:image-sizes:
  stage: test
  image: docker:27-cli
  needs:
    - build:php:prod
    - build:php:dev
    - build:php:test
    - build:node:prod
    - build:node:dev
    - build:node:test
    - build:mysql
    - build:redis
    - build:nginx
    - build:mailhog
    - build:minio
    - build:e2e-testing
    - build:performance-testing
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - echo "ðŸ“Š Tracking Docker image sizesâ€¦"
    - |
      cat > image-sizes.txt <<EOF
      ========================================
      ZAIRAKAI DOCKER ECOSYSTEM - IMAGE SIZES
      ========================================
      Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
      Pipeline: $CI_PIPELINE_ID
      Commit: $CI_COMMIT_SHORT_SHA
      Tag: $CI_COMMIT_TAG
      ========================================

      EOF
    - |
      for image in \
        "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-prod" \
        "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-dev" \
        "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-test" \
        "$CI_REGISTRY_IMAGE/node:20$IMAGE_SUFFIX-prod" \
        "$CI_REGISTRY_IMAGE/node:20$IMAGE_SUFFIX-dev" \
        "$CI_REGISTRY_IMAGE/node:20$IMAGE_SUFFIX-test" \
        "$CI_REGISTRY_IMAGE/database:mysql-8.0$IMAGE_SUFFIX" \
        "$CI_REGISTRY_IMAGE/database:redis-7$IMAGE_SUFFIX" \
        "$CI_REGISTRY_IMAGE/web:nginx-1.26$IMAGE_SUFFIX" \
        "$CI_REGISTRY_IMAGE/services:mailhog$IMAGE_SUFFIX" \
        "$CI_REGISTRY_IMAGE/services:minio$IMAGE_SUFFIX" \
        "$CI_REGISTRY_IMAGE/services:e2e-testing$IMAGE_SUFFIX" \
        "$CI_REGISTRY_IMAGE/services:performance-testing$IMAGE_SUFFIX"
      do
        echo "â†’ Pulling $imageâ€¦"
        if ! docker pull "$image"; then
          echo "âŒ Failed to pull $image"
          exit 1
        fi
      done
    - echo "" >> image-sizes.txt
    - |
      docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" \
        | grep "$CI_COMMIT_SHORT_SHA" \
        >> image-sizes.txt
    - echo "" >> image-sizes.txt
    - echo "========================================" >> image-sizes.txt
    - |
      TOTAL_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$CI_COMMIT_SHORT_SHA" | wc -l)
      echo "TOTAL IMAGES: $TOTAL_IMAGES" >> image-sizes.txt
    - echo "========================================" >> image-sizes.txt
    - cat image-sizes.txt
  artifacts:
    paths:
      - image-sizes.txt
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

test:multi-stage-integrity:
  stage: test
  image: docker:27-cli
  needs:
    - build:php:prod
    - build:php:dev
    - build:php:test
    - build:node:prod
    - build:node:dev
    - build:node:test
  before_script:
    - apk add --no-cache bash jq
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸ” Verifying multi-stage build integrityâ€¦"
    - |
      echo "â†’ Checking PHP image stagesâ€¦"
      docker pull "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-prod"
      docker pull "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-dev"
      docker pull "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-test"

      echo "â†’ Checking Xdebug in prod (should NOT be present)â€¦"
      if docker run --rm "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-prod" php -m 2>/dev/null | grep -i "xdebug"; then
        echo "âŒ Xdebug found in production image (should not be present)"
        exit 1
      fi
      echo "âœ“ Xdebug correctly absent from prod"

      echo "â†’ Checking Xdebug in dev (should be present)â€¦"
      if ! docker run --rm "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-dev" php -m 2>/dev/null | grep -i "xdebug"; then
        echo "âŒ Xdebug not found in dev image (should be present)"
        exit 1
      fi
      echo "âœ“ Xdebug correctly present in dev"

      echo "â†’ Checking PCOV in test (should be present)â€¦"
      PCOV_CHECK=$(docker run --rm "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-test" sh -c 'php -m 2>&1 | grep -i "pcov" || echo "NOT_FOUND"')

      if echo "$PCOV_CHECK" | grep -q "NOT_FOUND"; then
        echo "âŒ PCOV not found in test image"
        echo "Available extensions:"
        docker run --rm "$CI_REGISTRY_IMAGE/php:8.3$IMAGE_SUFFIX-test" php -m 2>/dev/null || true
        exit 1
      fi
      echo "âœ“ PCOV correctly present in test"

      echo "âœ… Multi-stage integrity verified"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ================================
# PROMOTE STAGE
# ================================
promote:tags:
  stage: promote
  image: docker:27-cli
  needs:
    - build:php:prod
    - build:php:dev
    - build:php:test
    - build:node:prod
    - build:node:dev
    - build:node:test
    - build:mysql
    - build:redis
    - build:nginx
    - build:mailhog
    - build:minio
    - build:e2e-testing
    - build:performance-testing
    - test:image-sizes
    - test:multi-stage-integrity
  before_script:
    - apk add --no-cache bash
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸš€ Promoting images to stable tagsâ€¦"
    - chmod +x scripts/promote.sh
    - export PROMOTED_VERSION="$CI_COMMIT_TAG"
    - bash scripts/promote.sh
    - echo "âœ… Images promoted successfully"
  after_script:
    - docker logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

sync:dockerhub:
  stage: promote
  image: docker:27-cli
  needs:
    - promote:tags
  before_script:
    - apk add --no-cache bash
    # Login GitLab Registry
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    # Login Docker Hub
    - echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin docker.io
  script:
    - echo "ðŸ”„ Mirroring stable images to Docker Hub..."
    - |
      # Images Ã  synchroniser (format GitLab â†’ Docker Hub)
      IMAGES=(
        "php:8.3-prod:zairakai/php:8.3-prod"
        "php:8.3-dev:zairakai/php:8.3-dev"
        "php:8.3-test:zairakai/php:8.3-test"
        "php:latest-prod:zairakai/php:latest-prod"
        "php:latest-dev:zairakai/php:latest-dev"
        "node:20-prod:zairakai/node:20-prod"
        "node:20-dev:zairakai/node:20-dev"
        "node:20-test:zairakai/node:20-test"
        "node:latest-prod:zairakai/node:latest-prod"
        "node:latest-dev:zairakai/node:latest-dev"
        "database:mysql-8.0:zairakai/mysql:8.0"
        "database:redis-7:zairakai/redis:7"
        "web:nginx-1.26:zairakai/nginx:1.26"
        "services:mailhog:zairakai/mailhog:latest"
        "services:minio:zairakai/minio:latest"
      )

      for mapping in "${IMAGES[@]}"; do
        GITLAB_TAG="${mapping%%:*}"
        DOCKERHUB_TAG="${mapping##*:}"
        
        echo "â†’ Syncing ${GITLAB_TAG} to Docker Hub as ${DOCKERHUB_TAG}..."
        
        # Pull from GitLab
        docker pull ${CI_REGISTRY_IMAGE}/${GITLAB_TAG}
        
        # Tag for Docker Hub
        docker tag ${CI_REGISTRY_IMAGE}/${GITLAB_TAG} ${DOCKERHUB_TAG}
        
        # Push to Docker Hub
        docker push ${DOCKERHUB_TAG}
        
        echo "âœ… ${DOCKERHUB_TAG} synced"
      done

      echo "âœ… All images mirrored to Docker Hub"
  after_script:
    - docker logout $CI_REGISTRY
    - docker logout docker.io
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  allow_failure: true

# ================================
# CLEANUP STAGE
# ================================
cleanup:staging-tags:
  stage: cleanup
  image: docker:27-cli
  needs:
    - promote:tags
  before_script:
    - apk add --no-cache bash curl jq
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸ§¹ Cleaning up staging tagsâ€¦"
    - chmod +x scripts/cleanup.sh
    - bash scripts/cleanup.sh
    - echo "âœ… Cleanup completed"
  after_script:
    - docker logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  when: always
  allow_failure: true
